---
phase: 02-authentication-profiles
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/(app)/settings/profile/page.tsx
  - src/app/(app)/settings/layout.tsx
  - src/app/(app)/layout.tsx
  - src/app/actions/profile.ts
  - src/shared/components/ProfileForm.tsx
  - src/shared/components/UserMenu.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their profile on /settings/profile"
    - "User can edit display name, bio with auto-save"
    - "Profile changes save automatically after 3 seconds of inactivity"
    - "User can log out from the user menu in header"
    - "GitHub profile data (avatar, name, bio) is displayed"
  artifacts:
    - path: "src/app/(app)/settings/profile/page.tsx"
      provides: "Profile settings page with tabbed interface"
      min_lines: 40
    - path: "src/app/actions/profile.ts"
      provides: "Server Actions for profile updates"
      exports: ["updateProfile"]
    - path: "src/shared/components/ProfileForm.tsx"
      provides: "Profile form with auto-save"
      min_lines: 50
    - path: "src/shared/components/UserMenu.tsx"
      provides: "User dropdown with logout"
      min_lines: 40
  key_links:
    - from: "src/shared/components/ProfileForm.tsx"
      to: "src/app/actions/profile.ts"
      via: "calls updateProfile action"
      pattern: "updateProfile"
    - from: "src/shared/components/ProfileForm.tsx"
      to: "src/shared/hooks/useDebounce.ts"
      via: "uses useDebounce hook"
      pattern: "useDebounce"
    - from: "src/shared/components/UserMenu.tsx"
      to: "src/shared/lib/auth.ts"
      via: "imports signOut"
      pattern: "signOut"
---

<objective>
Create profile settings page with tabbed interface and auto-save functionality, plus logout capability from a user menu in the header.

Purpose: Enable users to manage their profile information with seamless auto-save (per CONTEXT.md: "Auto-save on change, no manual save buttons"). Provide logout from any page via header user menu.

Output: Profile settings page at /settings/profile with auto-save form, user menu component with logout, app layout with header.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-profiles/02-CONTEXT.md
@.planning/phases/02-authentication-profiles/02-RESEARCH.md

# Dependencies from prior plans
@src/shared/lib/auth.ts
@src/shared/lib/dal.ts
@src/shared/hooks/useDebounce.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create App Layout with Header and User Menu</name>
  <files>src/app/(app)/layout.tsx, src/shared/components/UserMenu.tsx</files>
  <action>
1. Create UserMenu component at src/shared/components/UserMenu.tsx:

```typescript
'use client'

import { useState, useRef, useEffect } from 'react'
import Link from 'next/link'

interface UserMenuProps {
  user: {
    name?: string | null
    email?: string | null
    image?: string | null
  }
  signOutAction: () => Promise<void>
}

export function UserMenu({ user, signOutAction }: UserMenuProps) {
  const [isOpen, setIsOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)

  // Close menu when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  return (
    <div className="relative" ref={menuRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
      >
        {user.image ? (
          <img
            src={user.image}
            alt={user.name || 'User avatar'}
            className="w-8 h-8 rounded-full"
          />
        ) : (
          <div className="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">
              {user.name?.[0] || user.email?.[0] || '?'}
            </span>
          </div>
        )}
        <svg
          className={`w-4 h-4 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
          <div className="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
            <p className="text-sm font-medium text-gray-900 dark:text-white">
              {user.name || 'User'}
            </p>
            <p className="text-xs text-gray-500 dark:text-gray-400 truncate">
              {user.email}
            </p>
          </div>

          <Link
            href="/settings/profile"
            onClick={() => setIsOpen(false)}
            className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
          >
            Profile Settings
          </Link>

          <hr className="my-1 border-gray-200 dark:border-gray-700" />

          <form action={signOutAction}>
            <button
              type="submit"
              className="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              Sign out
            </button>
          </form>
        </div>
      )}
    </div>
  )
}
```

2. Create app layout at src/app/(app)/layout.tsx:

```typescript
import Link from 'next/link'
import { redirect } from 'next/navigation'
import { auth, signOut } from '@/shared/lib/auth'
import { UserMenu } from '@/shared/components/UserMenu'

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const session = await auth()

  // Protect all routes in (app) group
  if (!session?.user) {
    redirect('/login')
  }

  // Server Action for sign out (passed to client component)
  async function handleSignOut() {
    'use server'
    await signOut({ redirectTo: '/' })
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
      {/* Header */}
      <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="container mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-6">
            <Link href="/dashboard" className="text-xl font-bold text-gray-900 dark:text-white">
              Task Tracker
            </Link>
            <nav className="hidden md:flex items-center gap-4">
              <Link
                href="/dashboard"
                className="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
              >
                Dashboard
              </Link>
              <Link
                href="/tasks"
                className="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
              >
                Tasks
              </Link>
            </nav>
          </div>

          <UserMenu user={session.user} signOutAction={handleSignOut} />
        </div>
      </header>

      {/* Main content */}
      <main className="container mx-auto px-4 py-8">
        {children}
      </main>
    </div>
  )
}
```

Create directories:
```bash
mkdir -p src/app/\(app\)
mkdir -p src/shared/components
```

3. Create component index at src/shared/components/index.ts:
```typescript
export { UserMenu } from './UserMenu'
```
  </action>
  <verify>
- File exists at src/app/(app)/layout.tsx
- File exists at src/shared/components/UserMenu.tsx
- `npm run build` succeeds
- UserMenu component exports properly
  </verify>
  <done>
App layout created with header and user menu. Logout functionality accessible from dropdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Profile Server Actions</name>
  <files>src/app/actions/profile.ts</files>
  <action>
Create Server Actions for profile updates at src/app/actions/profile.ts:

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { z } from 'zod'
import { verifySession } from '@/shared/lib/dal'
import { prisma } from '@/shared/lib/db'

// Validation schema for profile updates
const profileSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  bio: z.string().max(500).optional(),
})

export type ProfileUpdateResult = {
  success: boolean
  error?: string
  field?: string
}

/**
 * Update a single profile field.
 * Used for auto-save pattern - called on individual field changes.
 */
export async function updateProfileField(
  field: 'name' | 'bio',
  value: string
): Promise<ProfileUpdateResult> {
  try {
    const { userId } = await verifySession()

    // Validate the specific field
    const validation = profileSchema.shape[field]?.safeParse(value)
    if (validation && !validation.success) {
      return {
        success: false,
        error: validation.error.errors[0]?.message || 'Invalid value',
        field,
      }
    }

    // Update only the changed field
    await prisma.user.update({
      where: { id: userId },
      data: { [field]: value || null },
    })

    revalidatePath('/settings/profile')
    return { success: true }
  } catch (error) {
    console.error('Profile update error:', error)
    return {
      success: false,
      error: 'Failed to save changes. Please try again.',
      field,
    }
  }
}

/**
 * Update multiple profile fields at once.
 * Used for form submission or bulk updates.
 */
export async function updateProfile(
  formData: FormData
): Promise<ProfileUpdateResult> {
  try {
    const { userId } = await verifySession()

    const data = {
      name: formData.get('name') as string | null,
      bio: formData.get('bio') as string | null,
    }

    // Validate all fields
    const validation = profileSchema.safeParse(data)
    if (!validation.success) {
      const firstError = validation.error.errors[0]
      return {
        success: false,
        error: firstError?.message || 'Invalid input',
        field: firstError?.path[0] as string,
      }
    }

    await prisma.user.update({
      where: { id: userId },
      data: {
        name: data.name || null,
        bio: data.bio || null,
      },
    })

    revalidatePath('/settings/profile')
    return { success: true }
  } catch (error) {
    console.error('Profile update error:', error)
    return {
      success: false,
      error: 'Failed to save changes. Please try again.',
    }
  }
}
```

Create directory:
```bash
mkdir -p src/app/actions
```

This provides:
- updateProfileField: For auto-save of individual fields
- updateProfile: For bulk form submission
- Zod validation with meaningful error messages
- verifySession for auth check
  </action>
  <verify>
- File exists at src/app/actions/profile.ts
- `npx tsc --noEmit` passes with no type errors
- Exports updateProfileField and updateProfile
  </verify>
  <done>
Profile Server Actions created with field-level auto-save support and validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Profile Settings Page with Auto-Save Form</name>
  <files>src/shared/components/ProfileForm.tsx, src/app/(app)/settings/profile/page.tsx, src/app/(app)/settings/layout.tsx</files>
  <action>
1. Create ProfileForm component at src/shared/components/ProfileForm.tsx:

```typescript
'use client'

import { useState, useCallback } from 'react'
import { useDebounce } from '@/shared/hooks/useDebounce'
import { updateProfileField, type ProfileUpdateResult } from '@/app/actions/profile'

interface ProfileFormProps {
  user: {
    id: string
    name?: string | null
    email?: string | null
    image?: string | null
    bio?: string | null
    customAvatar?: string | null
  }
}

type SaveStatus = 'idle' | 'saving' | 'saved' | 'error'

export function ProfileForm({ user }: ProfileFormProps) {
  const [status, setStatus] = useState<SaveStatus>('idle')
  const [error, setError] = useState<string | null>(null)

  // Debounced save function
  const saveField = useCallback(async (field: 'name' | 'bio', value: string) => {
    setStatus('saving')
    setError(null)

    const result: ProfileUpdateResult = await updateProfileField(field, value)

    if (result.success) {
      setStatus('saved')
      // Reset to idle after 2 seconds
      setTimeout(() => setStatus('idle'), 2000)
    } else {
      setStatus('error')
      setError(result.error || 'Failed to save')
    }
  }, [])

  const debouncedSave = useDebounce(saveField, 3000)

  const handleChange = (field: 'name' | 'bio') => (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    debouncedSave(field, e.target.value)
  }

  return (
    <div className="space-y-6">
      {/* Status indicator */}
      <div className="flex items-center gap-2 text-sm">
        {status === 'saving' && (
          <>
            <div className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse" />
            <span className="text-gray-500 dark:text-gray-400">Saving...</span>
          </>
        )}
        {status === 'saved' && (
          <>
            <div className="w-2 h-2 bg-green-500 rounded-full" />
            <span className="text-green-600 dark:text-green-400">Saved</span>
          </>
        )}
        {status === 'error' && (
          <>
            <div className="w-2 h-2 bg-red-500 rounded-full" />
            <span className="text-red-600 dark:text-red-400">{error}</span>
          </>
        )}
      </div>

      {/* GitHub Profile Info (read-only) */}
      <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
        <div className="flex items-center gap-4">
          {user.image && (
            <img
              src={user.image}
              alt={user.name || 'GitHub avatar'}
              className="w-16 h-16 rounded-full"
            />
          )}
          <div>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              Connected GitHub account
            </p>
            <p className="font-medium text-gray-900 dark:text-white">
              {user.email}
            </p>
          </div>
        </div>
      </div>

      {/* Editable fields */}
      <div className="space-y-4">
        <div>
          <label
            htmlFor="name"
            className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >
            Display Name
          </label>
          <input
            type="text"
            id="name"
            name="name"
            defaultValue={user.name || ''}
            onChange={handleChange('name')}
            placeholder="Your display name"
            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            maxLength={100}
          />
          <p className="mt-1 text-xs text-gray-500 dark:text-gray-400">
            This is how your name appears across the app
          </p>
        </div>

        <div>
          <label
            htmlFor="bio"
            className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
          >
            Bio
          </label>
          <textarea
            id="bio"
            name="bio"
            defaultValue={user.bio || ''}
            onChange={handleChange('bio')}
            placeholder="Tell us about yourself"
            rows={4}
            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            maxLength={500}
          />
          <p className="mt-1 text-xs text-gray-500 dark:text-gray-400">
            A short description (max 500 characters)
          </p>
        </div>
      </div>

      {/* Note about auto-save */}
      <p className="text-xs text-gray-500 dark:text-gray-400 italic">
        Changes are saved automatically
      </p>
    </div>
  )
}
```

2. Create settings layout at src/app/(app)/settings/layout.tsx:

```typescript
import Link from 'next/link'

export default function SettingsLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6">
        Settings
      </h1>

      <div className="flex flex-col md:flex-row gap-8">
        {/* Settings navigation - tabbed per CONTEXT.md */}
        <nav className="w-full md:w-48 flex-shrink-0">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-2">
            <Link
              href="/settings/profile"
              className="block px-4 py-2 text-sm font-medium text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 rounded-lg"
            >
              Profile
            </Link>
            {/* Future tabs: Account, Notifications, etc. */}
          </div>
        </nav>

        {/* Settings content */}
        <div className="flex-1">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
            {children}
          </div>
        </div>
      </div>
    </div>
  )
}
```

3. Create profile page at src/app/(app)/settings/profile/page.tsx:

```typescript
import { getUser } from '@/shared/lib/dal'
import { ProfileForm } from '@/shared/components/ProfileForm'

export default async function ProfilePage() {
  const user = await getUser()

  if (!user) {
    // This shouldn't happen due to layout protection, but handle gracefully
    return (
      <div className="text-center py-8">
        <p className="text-gray-600 dark:text-gray-400">
          Unable to load profile. Please try again.
        </p>
      </div>
    )
  }

  return (
    <div>
      <h2 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        Profile Information
      </h2>
      <ProfileForm user={user} />
    </div>
  )
}
```

Create directories:
```bash
mkdir -p src/app/\(app\)/settings/profile
```

4. Update components index at src/shared/components/index.ts:
```typescript
export { UserMenu } from './UserMenu'
export { ProfileForm } from './ProfileForm'
```
  </action>
  <verify>
- File exists at src/shared/components/ProfileForm.tsx
- File exists at src/app/(app)/settings/profile/page.tsx
- File exists at src/app/(app)/settings/layout.tsx
- `npm run build` succeeds
- ProfileForm uses useDebounce hook
  </verify>
  <done>
Profile settings page created with tabbed layout and auto-save form. Changes save automatically after 3 seconds.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   - `npm run build` completes successfully

2. Type checking:
   - `npx tsc --noEmit` passes

3. Route verification:
   - /settings/profile requires authentication
   - Profile form displays user info
   - User menu appears in header

4. Functionality verification (requires OAuth setup):
   - Profile fields auto-save after typing stops
   - Logout from user menu works
</verification>

<success_criteria>
- [ ] App layout with header and user menu created
- [ ] UserMenu component with logout functionality
- [ ] Profile Server Actions with field-level updates
- [ ] ProfileForm with auto-save using useDebounce
- [ ] Settings layout with tabbed navigation
- [ ] Profile page at /settings/profile
- [ ] Build succeeds without errors
- [ ] Auto-save indicator shows saving/saved/error states
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-profiles/02-04-SUMMARY.md`
</output>
