---
phase: 02-authentication-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:

  - prisma/schema.prisma
  - src/shared/lib/auth.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - package.json

autonomous: true
user_setup:

  - service: github-oauth

    why: "GitHub OAuth for user authentication"
    env_vars:

      - name: AUTH_GITHUB_ID

        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> New OAuth App -> Client ID"

      - name: AUTH_GITHUB_SECRET

        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> (your app) -> Client secrets -> Generate"

      - name: AUTH_SECRET

        source: "Run: npx auth secret (generates random secret)"
    dashboard_config:

      - task: "Create OAuth App"

        location: "GitHub Settings -> Developer settings -> OAuth Apps"
        details: "Homepage URL: http://localhost:3000, Callback URL: http://localhost:3000/api/auth/callback/github"

must_haves:
  truths:

    - "Auth.js v5 is installed and configured with GitHub provider"
    - "Database schema includes User, Account, Session, VerificationToken models"
    - "Auth API routes respond at /api/auth/*"

  artifacts:

    - path: "prisma/schema.prisma"

      provides: "Auth.js compatible database models"
      contains: "model User"

    - path: "src/shared/lib/auth.ts"

      provides: "Auth.js configuration with GitHub OAuth"
      exports: ["auth", "signIn", "signOut", "handlers"]

    - path: "src/app/api/auth/[...nextauth]/route.ts"

      provides: "Auth.js route handlers"
      exports: ["GET", "POST"]
  key_links:

    - from: "src/app/api/auth/[...nextauth]/route.ts"

      to: "src/shared/lib/auth.ts"
      via: "imports handlers"
      pattern: "import.*handlers.*from.*auth"

    - from: "src/shared/lib/auth.ts"

      to: "prisma/schema.prisma"
      via: "PrismaAdapter uses Prisma client"
      pattern: "PrismaAdapter"
---

<objective>
Install and configure Auth.js v5 with GitHub OAuth provider and Prisma adapter for database-backed sessions.

Purpose: Establish authentication infrastructure that all protected routes and user features will build upon. Auth.js v5 provides secure OAuth handling, CSRF protection, and session management out of the box.

Output: Working Auth.js configuration with GitHub provider, database schema for auth models, and API route handlers at /api/auth/*.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-profiles/02-CONTEXT.md
@.planning/phases/02-authentication-profiles/02-RESEARCH.md

# Existing infrastructure from Phase 1

@prisma/schema.prisma
@src/shared/lib/db/prisma.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma Schema with Auth.js Models</name>
  <files>prisma/schema.prisma</files>
  <action>
Update prisma/schema.prisma to add Auth.js required models. Keep the existing HealthCheck model for now.

Add these models (exact schema from Auth.js Prisma adapter docs):

```prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // Custom profile fields (per CONTEXT.md)
  bio           String?
  customAvatar  String?  // URL to uploaded avatar (overrides GitHub image)

  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

```

IMPORTANT: Use @db.Text for token fields (refresh_token, access_token, id_token) because GitHub tokens can exceed varchar(191) limit.

After updating schema, run migration:

```bash
npx prisma migrate dev --name add_auth_models

```

Then generate Prisma client:

```bash
npx prisma generate

```

  </action>
  <verify>

- `npx prisma migrate status` shows all migrations applied
- `npx prisma studio` opens and shows User, Account, Session, VerificationToken tables
- No TypeScript errors in prisma.ts after regenerating client

  </verify>
  <done>
Database schema contains all Auth.js required models with proper relations. Migration applied successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Auth.js Dependencies and Create Configuration</name>
  <files>src/shared/lib/auth.ts, package.json</files>
  <action>

1. Install Auth.js v5 and Prisma adapter:

```bash
npm install next-auth@beta @auth/prisma-adapter

```

2. Create src/shared/lib/auth.ts with GitHub OAuth configuration:

```typescript
import NextAuth from "next-auth"
import GitHub from "next-auth/providers/github"
import { PrismaAdapter } from "@auth/prisma-adapter"
import { prisma } from "@/shared/lib/db"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    GitHub({
      clientId: process.env.AUTH_GITHUB_ID!,
      clientSecret: process.env.AUTH_GITHUB_SECRET!,
      authorization: {
        params: {
          // Scopes: user profile + email + repo read access (per CONTEXT.md)
          scope: "read:user user:email repo"
        }
      }
    })
  ],
  session: {
    strategy: "database",  // Database sessions (not JWT) per RESEARCH.md
    maxAge: 24 * 60 * 60,  // 24 hours per CONTEXT.md
    updateAge: 60 * 60,    // Silent refresh every hour
  },
  callbacks: {
    async session({ session, user }) {
      // Add user ID to session for easy access
      session.user.id = user.id
      return session
    },
    async redirect({ url, baseUrl }) {
      // After OAuth, redirect to welcome for first-time users (per CONTEXT.md)
      // For subsequent logins, let the default behavior work
      if (url.startsWith(baseUrl)) return url
      return `${baseUrl}/welcome`
    }
  },
  pages: {
    signIn: '/login',
    error: '/login',  // Redirect errors to login with error param (per CONTEXT.md)
  }
})

```

3. Add type declaration for extended session (create src/shared/types/next-auth.d.ts):

```typescript
import { DefaultSession } from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
    } & DefaultSession["user"]
  }
}

```

4. Update .env.example with new variables:

```

# Auth.js

AUTH_GITHUB_ID=your_github_oauth_client_id
AUTH_GITHUB_SECRET=your_github_oauth_client_secret
AUTH_SECRET=generate_with_npx_auth_secret

```

IMPORTANT: Do NOT add actual secrets to .env.example. Only add to .env (which is gitignored).
  </action>
  <verify>

- `npm ls next-auth` shows next-auth@5.x installed
- `npm ls @auth/prisma-adapter` shows adapter installed
- `npx tsc --noEmit` passes with no type errors
- src/shared/lib/auth.ts exports handlers, auth, signIn, signOut

  </verify>
  <done>
Auth.js v5 installed with GitHub provider configured. Type declarations extended for session.user.id access.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Auth API Route Handler</name>
  <files>src/app/api/auth/[...nextauth]/route.ts</files>
  <action>
Create the catch-all route handler for Auth.js at src/app/api/auth/[...nextauth]/route.ts:

```typescript
import { handlers } from "@/shared/lib/auth"

export const { GET, POST } = handlers

```

This minimal route file exposes all Auth.js endpoints:

- GET /api/auth/signin - Sign in page
- POST /api/auth/signin - Sign in action
- GET /api/auth/callback/github - GitHub OAuth callback
- POST /api/auth/signout - Sign out action
- GET /api/auth/session - Get current session
- GET /api/auth/csrf - Get CSRF token
- GET /api/auth/providers - Get available providers

Create the directory structure:

```bash
mkdir -p src/app/api/auth/\[...nextauth\]

```

Verify the route is working by checking that the endpoint responds (will fail auth without env vars, but should return valid response):

```bash
curl http://localhost:3000/api/auth/providers

```

  </action>
  <verify>

- File exists at src/app/api/auth/[...nextauth]/route.ts
- `npm run build` succeeds without errors
- `npm run dev` starts and route is accessible
- `curl http://localhost:3000/api/auth/providers` returns JSON (may show empty providers without env vars)

  </verify>
  <done>
Auth.js API route handler created. All /api/auth/* endpoints are functional.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema verification:
   - `npx prisma migrate status` shows all migrations applied
   - Database has User, Account, Session, VerificationToken tables

2. Build verification:
   - `npm run build` completes without errors
   - No TypeScript errors related to auth

3. Runtime verification:
   - `npm run dev` starts successfully
   - `curl http://localhost:3000/api/auth/providers` returns valid JSON
   - `curl http://localhost:3000/api/auth/csrf` returns CSRF token

</verification>

<success_criteria>

- [ ] Prisma schema includes all Auth.js models (User, Account, Session, VerificationToken)
- [ ] Migration applied successfully to database
- [ ] next-auth@beta and @auth/prisma-adapter installed
- [ ] src/shared/lib/auth.ts exports handlers, auth, signIn, signOut
- [ ] Auth API routes respond at /api/auth/*
- [ ] Build passes with no TypeScript errors
- [ ] .env.example updated with AUTH_* variable templates

</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-profiles/02-01-SUMMARY.md`
</output>
