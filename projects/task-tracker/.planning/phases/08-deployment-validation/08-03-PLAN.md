---
phase: 08-deployment-validation
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - .github/workflows/deploy.yml
  - prisma/schema.prisma
  - vercel.json
autonomous: false
user_setup:
  - service: github_secrets
    why: "CI/CD pipeline needs access to Vercel and database"
    env_vars:
      - name: VERCEL_TOKEN
        source: "Vercel Dashboard -> Settings -> Tokens"
      - name: VERCEL_ORG_ID
        source: "Vercel Dashboard -> Settings -> General"
      - name: VERCEL_PROJECT_ID
        source: "Vercel Project Settings -> General"
      - name: DATABASE_URL
        source: "Neon Dashboard -> Connection String"

must_haves:
  truths:
    - "Pushing to main triggers automated deployment"
    - "Database migrations run before deployment"
    - "Application is accessible at public Vercel URL"
    - "Production database is connected and functional"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline configuration"
      min_lines: 30
    - path: "vercel.json"
      provides: "Vercel deployment configuration"
      contains: "framework"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "vercel"
      via: "vercel CLI deployment"
      pattern: "vercel --prod"
    - from: ".github/workflows/deploy.yml"
      to: "prisma"
      via: "migration deployment"
      pattern: "prisma migrate deploy"
---

<objective>
Create CI/CD pipeline and deploy application to Vercel production.

Purpose: Establish automated deployment workflow and get the application live on a public URL for real user testing.

Output: GitHub Actions workflow, Vercel configuration, deployed production application.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-validation/08-RESEARCH.md
@.planning/phases/08-deployment-validation/08-01-PLAN.md
@.planning/phases/08-deployment-validation/08-02-PLAN.md

@package.json
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vercel configuration file</name>
  <files>vercel.json</files>
  <action>
Create vercel.json in project root with deployment settings:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "installCommand": "npm install",
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

Notes:
- Set maxDuration to 30 seconds for API routes (file uploads, database operations)
- Do NOT set NODE_ENV in vercel.json - Vercel sets it automatically
- Do NOT specify output directory - Next.js defaults are correct
  </action>
  <verify>
Check file exists: ls vercel.json
File is valid JSON: cat vercel.json | python3 -m json.tool
Contains "framework": "nextjs"
  </verify>
  <done>Vercel configuration file created with proper settings</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deployment workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create GitHub Actions workflow for automated deployment:

1. Create .github/workflows/deploy.yml
2. Trigger on push to main branch
3. Jobs:
   a) Install dependencies (npm ci)
   b) Run Prisma migrations (npx prisma migrate deploy)
   c) Deploy to Vercel (vercel --prod)

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
```

Notes:
- Use npm ci for reproducible installs
- Run migrations BEFORE deployment
- Use Vercel CLI's prebuilt deployment for faster deploys
- All secrets come from GitHub repository secrets
  </action>
  <verify>
Check directory and file exist: ls -la .github/workflows/deploy.yml
YAML is valid: python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"
Contains 'prisma migrate deploy'
Contains 'vercel deploy --prebuilt --prod'
  </verify>
  <done>GitHub Actions workflow created for automated deployment</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>
CI/CD pipeline and Vercel configuration files are ready.
Now need to set up external services and deploy.
  </what-built>
  <action>Set up production infrastructure and trigger first deployment</action>
  <instructions>
**REQUIRED: Complete these steps before continuing**

### Step 1: Create Neon Database (5 min)

1. Go to https://console.neon.tech
2. Sign in with GitHub
3. Create new project: "task-tracker-prod"
4. Copy the connection string (pooled) - this is DATABASE_URL
5. Copy the direct connection string - this is DIRECT_URL (for migrations)

### Step 2: Create Vercel Project (3 min)

1. Go to https://vercel.com/new
2. Import your GitHub repository
3. Select "task-tracker" repository
4. DO NOT deploy yet - just create the project
5. Go to Project Settings -> General
6. Copy Project ID and Org ID

### Step 3: Create Vercel API Token (2 min)

1. Go to https://vercel.com/account/tokens
2. Create new token named "github-actions-deploy"
3. Copy the token

### Step 4: Add GitHub Secrets (3 min)

Go to your GitHub repository -> Settings -> Secrets and variables -> Actions -> New repository secret

Add these secrets:
- `VERCEL_TOKEN`: (from Step 3)
- `VERCEL_ORG_ID`: (from Step 2)
- `VERCEL_PROJECT_ID`: (from Step 2)
- `DATABASE_URL`: (pooled connection from Step 1)

### Step 5: Add Vercel Environment Variables (3 min)

1. Go to Vercel Project -> Settings -> Environment Variables
2. Add for Production environment:
   - `DATABASE_URL`: (pooled connection from Neon)
   - `AUTH_SECRET`: Run `openssl rand -base64 32` and paste result
   - `AUTH_GITHUB_ID`: Your GitHub OAuth App Client ID
   - `AUTH_GITHUB_SECRET`: Your GitHub OAuth App Client Secret

Note: You need to create a NEW GitHub OAuth App for production:
- Go to https://github.com/settings/developers
- Create new OAuth App
- Homepage URL: https://your-project.vercel.app
- Callback URL: https://your-project.vercel.app/api/auth/callback/github

### Step 6: Trigger Deployment (1 min)

Push the workflow file to trigger deployment:
```bash
git add .github/workflows/deploy.yml vercel.json
git commit -m "ci: add Vercel deployment workflow"
git push origin main
```

### Step 7: Verify Deployment

1. Go to GitHub Actions tab - check workflow succeeds
2. Visit your Vercel URL (shown in workflow output)
3. Verify app loads and GitHub login works

  </instructions>
  <resume-signal>
Type "deployed" when the application is live on Vercel and you've verified:
1. GitHub Actions workflow succeeded
2. App is accessible at Vercel URL
3. GitHub login works

Or describe any issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
- [ ] vercel.json exists with proper configuration
- [ ] .github/workflows/deploy.yml exists and is valid YAML
- [ ] GitHub Actions workflow triggered on push to main
- [ ] Prisma migrations ran successfully
- [ ] Application deployed to Vercel
- [ ] Application accessible at public URL
</verification>

<success_criteria>
- Pushing to main triggers automated deployment
- Database migrations run before deployment
- Application is live and accessible
- GitHub OAuth works in production
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-validation/08-03-SUMMARY.md`
</output>
