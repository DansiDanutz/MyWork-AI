---
phase: 08-deployment-validation
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - .github/workflows/deploy.yml
  - prisma/schema.prisma
  - vercel.json
autonomous: false
user_setup:
  - service: github_secrets
    why: "CI/CD pipeline needs access to Vercel and database"
    env_vars:
      - name: VERCEL_TOKEN
        source: "Vercel Dashboard -> Settings -> Tokens"
      - name: VERCEL_ORG_ID
        source: "Vercel Dashboard -> Settings -> General"
      - name: VERCEL_PROJECT_ID
        source: "Vercel Project Settings -> General"
      - name: DATABASE_URL
        source: "Neon Dashboard -> Connection String"

must_haves:
  truths:
    - "Pushing to main triggers automated deployment"
    - "Database migrations run before deployment"
    - "Application is accessible at public Vercel URL"
    - "Production database is connected and functional"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline configuration"
      min_lines: 30
    - path: "vercel.json"
      provides: "Vercel deployment configuration"
      contains: "framework"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "vercel"
      via: "vercel CLI deployment"
      pattern: "vercel --prod"
    - from: ".github/workflows/deploy.yml"
      to: "prisma"
      via: "migration deployment"
      pattern: "prisma migrate deploy"
---

<objective>
Create CI/CD pipeline and deploy application to Vercel production.

Purpose: Establish automated deployment workflow and get the application live on a public URL for real user testing.

Output: GitHub Actions workflow, Vercel configuration, deployed production application.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-validation/08-RESEARCH.md
@.planning/phases/08-deployment-validation/08-01-PLAN.md
@.planning/phases/08-deployment-validation/08-02-PLAN.md

@package.json
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vercel configuration file</name>
  <files>vercel.json</files>
  <action>
Create vercel.json in project root with deployment settings:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "installCommand": "npm install",
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

Notes:
- Set maxDuration to 30 seconds for API routes (file uploads, database operations)
- Do NOT set NODE_ENV in vercel.json - Vercel sets it automatically
- Do NOT specify output directory - Next.js defaults are correct
  </action>
  <verify>
Check file exists: ls vercel.json
File is valid JSON: cat vercel.json | python3 -m json.tool
Contains "framework": "nextjs"
  </verify>
  <done>Vercel configuration file created with proper settings</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deployment workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create GitHub Actions workflow for automated deployment:

1. Create .github/workflows/deploy.yml
2. Trigger on push to main branch
3. Jobs:
   a) Install dependencies (npm ci)
   b) Run Prisma migrations (npx prisma migrate deploy)
   c) Deploy to Vercel (vercel --prod)

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOY_URL"
```

Notes:
- Use npm ci for reproducible installs
- Run migrations BEFORE deployment
- Use Vercel CLI's prebuilt deployment for faster deploys
- All secrets come from GitHub repository secrets
- Output deployment URL for easy access
  </action>
  <verify>
Check directory and file exist: ls -la .github/workflows/deploy.yml
YAML is valid: python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"
Contains 'prisma migrate deploy'
Contains 'vercel deploy --prebuilt --prod'
  </verify>
  <done>GitHub Actions workflow created for automated deployment</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>
CI/CD pipeline and Vercel configuration files are ready.
Now need to set up external services and deploy.
  </what-built>
  <action>Set up production infrastructure and trigger first deployment</action>
  <instructions>
**DEPLOYMENT SETUP - Complete in Order**

This checkpoint has 3 parts. Complete each part fully before moving to the next.

---

## PART A: Database & Hosting Setup (8 min)

### A1. Create Neon Database

1. Go to https://console.neon.tech
2. Sign in with GitHub
3. Create new project: "task-tracker-prod"
4. Copy and save these values:
   - **Pooled connection string** -> This is your DATABASE_URL
   - **Direct connection string** -> This is DIRECT_URL (for migrations)

**Verify A1:** You have both connection strings saved locally.

### A2. Create Vercel Project

1. Go to https://vercel.com/new
2. Import your GitHub repository (task-tracker)
3. **IMPORTANT:** Click "Skip" on the deploy step - DO NOT deploy yet
4. Go to Project Settings -> General
5. Copy and save:
   - **Project ID** -> VERCEL_PROJECT_ID
   - **Org ID** (or Team ID) -> VERCEL_ORG_ID

**Verify A2:** You have Project ID and Org ID saved locally.

### A3. Create Vercel API Token

1. Go to https://vercel.com/account/tokens
2. Create new token named "github-actions-deploy"
3. Copy the token -> VERCEL_TOKEN

**Verify A3:** You have the Vercel token saved locally.

---

## PART B: Secrets Configuration (5 min)

### B1. Add GitHub Repository Secrets

Go to: GitHub Repository -> Settings -> Secrets and variables -> Actions -> New repository secret

Add these 4 secrets:
| Secret Name | Value |
|-------------|-------|
| VERCEL_TOKEN | (from A3) |
| VERCEL_ORG_ID | (from A2) |
| VERCEL_PROJECT_ID | (from A2) |
| DATABASE_URL | (pooled connection from A1) |

**Verify B1:** All 4 secrets visible in GitHub Actions secrets list.

### B2. Add Vercel Environment Variables

Go to: Vercel Project -> Settings -> Environment Variables

Add for **Production** environment:
| Variable | Value |
|----------|-------|
| DATABASE_URL | (pooled connection from A1) |
| AUTH_SECRET | Run: `openssl rand -base64 32` |
| AUTH_GITHUB_ID | (from your dev GitHub OAuth App for now) |
| AUTH_GITHUB_SECRET | (from your dev GitHub OAuth App for now) |

**Verify B2:** All 4 environment variables visible in Vercel dashboard.

---

## PART C: Deploy & Configure OAuth (4 min)

### C1. Trigger First Deployment

```bash
git add .github/workflows/deploy.yml vercel.json
git commit -m "ci: add Vercel deployment workflow"
git push origin main
```

### C2. Monitor Deployment

1. Go to GitHub Actions tab
2. Watch the "Deploy to Vercel" workflow
3. Wait for completion (should take 2-3 minutes)
4. Note the deployment URL from the workflow output (e.g., https://task-tracker-xxx.vercel.app)

**Verify C2:** Workflow shows green checkmark and deployment URL is visible.

### C3. Update GitHub OAuth App for Production

**CRITICAL:** This step must happen AFTER deployment succeeds.

1. Go to https://github.com/settings/developers
2. Click on your OAuth App (or create new one for production)
3. Update:
   - **Homepage URL:** https://your-actual-vercel-url.vercel.app
   - **Callback URL:** https://your-actual-vercel-url.vercel.app/api/auth/callback/github
4. Copy the new Client ID and Secret
5. Go back to Vercel Environment Variables and update:
   - AUTH_GITHUB_ID with the production Client ID
   - AUTH_GITHUB_SECRET with the production Secret

**Verify C3:** OAuth App shows production URLs, Vercel env vars updated.

### C4. Redeploy with Correct OAuth

After updating env vars, trigger a redeploy:
1. Vercel Dashboard -> Deployments -> Latest deployment
2. Click "..." menu -> Redeploy

**Verify C4:** New deployment succeeds.

---

**FINAL VERIFICATION:**
1. Visit your Vercel URL
2. Click "Sign in with GitHub"
3. OAuth flow completes successfully
4. You are logged in and redirected to /welcome

  </instructions>
  <resume-signal>
Type "deployed" when:
1. GitHub Actions workflow succeeded
2. App is accessible at Vercel URL
3. GitHub OAuth login works with production callback URL

Include your production URL in the response.

Or describe any issues encountered with which PART/step failed.
  </resume-signal>
</task>

</tasks>

<verification>
- [ ] vercel.json exists with proper configuration
- [ ] .github/workflows/deploy.yml exists and is valid YAML
- [ ] GitHub Actions workflow triggered on push to main
- [ ] Prisma migrations ran successfully
- [ ] Application deployed to Vercel
- [ ] Application accessible at public URL
- [ ] GitHub OAuth callback URL updated for production
</verification>

<success_criteria>
- Pushing to main triggers automated deployment
- Database migrations run before deployment
- Application is live and accessible
- GitHub OAuth works in production (with correct callback URL)
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-validation/08-03-SUMMARY.md`
</output>
