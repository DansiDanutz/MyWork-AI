---
phase: 08-deployment-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/app/api/health/route.ts
  - src/shared/lib/env.ts
autonomous: true
user_setup:
  - service: neon
    why: "Serverless PostgreSQL database for production"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Dashboard -> Connection String (pooled)"
      - name: DIRECT_URL
        source: "Neon Dashboard -> Connection String (direct, for migrations)"
    dashboard_config:
      - task: "Create new project 'task-tracker-prod'"
        location: "https://console.neon.tech -> New Project"
  - service: vercel
    why: "Production deployment platform"
    env_vars:
      - name: VERCEL_TOKEN
        source: "Vercel Dashboard -> Settings -> Tokens -> Create"
      - name: VERCEL_ORG_ID
        source: "Vercel Dashboard -> Settings -> General -> Team ID"
      - name: VERCEL_PROJECT_ID
        source: "After Vercel project creation -> Settings -> General -> Project ID"
    dashboard_config:
      - task: "Link GitHub repository"
        location: "Vercel Dashboard -> Add New Project -> Import Git Repository"

must_haves:
  truths:
    - "Production health check endpoint returns database connectivity status"
    - "Security headers protect against XSS, clickjacking, and content sniffing"
    - "Environment variables are validated at startup before app runs"
  artifacts:
    - path: "next.config.ts"
      provides: "Security headers configuration"
      contains: "X-Content-Type-Options"
    - path: "src/app/api/health/route.ts"
      provides: "Enhanced health check with detailed status"
      exports: ["GET"]
    - path: "src/shared/lib/env.ts"
      provides: "Production environment validation"
      contains: "envSchema"
  key_links:
    - from: "src/app/api/health/route.ts"
      to: "prisma"
      via: "database connectivity check"
      pattern: "prisma\\.\\$queryRaw"
---

<objective>
Configure production infrastructure foundation with security hardening and health monitoring.

Purpose: Establish the security and monitoring foundation required for safe production deployment. Without these, the application would be vulnerable and unmonitorable.

Output: Security headers configured, enhanced health check endpoint, environment validation for production.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-validation/08-RESEARCH.md

@src/app/api/health/route.ts
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security headers to Next.js config</name>
  <files>next.config.ts</files>
  <action>
Update next.config.ts to add security headers that protect against common web vulnerabilities:

1. Add `headers()` async function to nextConfig that returns security headers for all paths:
   - X-Content-Type-Options: nosniff (prevents MIME sniffing)
   - X-Frame-Options: DENY (prevents clickjacking)
   - X-XSS-Protection: 1; mode=block (legacy XSS protection)
   - Referrer-Policy: strict-origin-when-cross-origin (limits referrer info)
   - Permissions-Policy: camera=(), microphone=(), geolocation=() (restrict APIs)

2. Apply headers to all routes using source: '/:path*'

3. Preserve existing config (experimental, serverExternalPackages, images)

Note: Do NOT add HSTS header - Vercel adds this automatically for HTTPS domains.
  </action>
  <verify>
Run `npm run build` - should complete successfully
Check next.config.ts contains X-Content-Type-Options, X-Frame-Options, X-XSS-Protection
  </verify>
  <done>Security headers configured in Next.js config for all routes</done>
</task>

<task type="auto">
  <name>Task 2: Enhance health check endpoint for production monitoring</name>
  <files>src/app/api/health/route.ts</files>
  <action>
Enhance the existing health check endpoint to provide detailed status information:

1. Add uptime tracking (process.uptime())
2. Add timestamp for when check was performed
3. Add database connectivity check using `prisma.$queryRaw\`SELECT 1\``
4. Return structured response:
   ```json
   {
     "status": "healthy" | "unhealthy",
     "checks": {
       "database": "healthy" | "unhealthy",
       "uptime": number (seconds),
       "timestamp": ISO string
     }
   }
   ```
5. Return 503 status code when unhealthy (database unreachable)
6. Catch database errors and include error message in response

Import prisma from @/shared/lib/prisma
  </action>
  <verify>
Start dev server: `npm run dev`
Check health endpoint: `curl http://localhost:3000/api/health`
Response should include status, checks.database, checks.uptime, checks.timestamp
  </verify>
  <done>Health check endpoint returns detailed status including database connectivity</done>
</task>

<task type="auto">
  <name>Task 3: Create production environment validation</name>
  <files>src/shared/lib/env.ts</files>
  <action>
Create environment validation module that validates required variables at startup:

1. Create src/shared/lib/env.ts
2. Define Zod schema for required production environment variables:
   - DATABASE_URL: z.string().url() - Required for Prisma
   - AUTH_SECRET: z.string().min(32) - Required for Auth.js
   - AUTH_GITHUB_ID: z.string() - Required for GitHub OAuth
   - AUTH_GITHUB_SECRET: z.string() - Required for GitHub OAuth
   - Optional: UPSTASH_REDIS_REST_URL, UPSTASH_REDIS_REST_TOKEN (for rate limiting)

3. Parse process.env through schema
4. Export validated env object for use in application
5. On parse failure, the error will naturally propagate at startup

Note: Use zod (already in package.json). Do NOT add NEXTAUTH_URL - Auth.js v5 infers this automatically.

Example usage after creation:
```typescript
import { env } from '@/shared/lib/env';
console.log(env.DATABASE_URL); // Type-safe access
```
  </action>
  <verify>
Check file exists: ls src/shared/lib/env.ts
TypeScript compiles: npx tsc --noEmit src/shared/lib/env.ts
Schema includes DATABASE_URL, AUTH_SECRET, AUTH_GITHUB_ID, AUTH_GITHUB_SECRET
  </verify>
  <done>Environment validation module validates required production variables with Zod</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds
- [ ] Security headers in next.config.ts (X-Content-Type-Options, X-Frame-Options)
- [ ] Health endpoint returns structured JSON with database status
- [ ] Environment validation file exists with Zod schema
</verification>

<success_criteria>
- Security headers protect against XSS, clickjacking, content sniffing
- Health check endpoint returns database connectivity status
- Environment validation catches missing required variables at startup
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-validation/08-01-SUMMARY.md`
</output>
