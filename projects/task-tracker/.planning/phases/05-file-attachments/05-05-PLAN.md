---
phase: 05-file-attachments
plan: 05
type: execute
wave: 4
depends_on: ["05-02", "05-03"]
files_modified:

  - src/shared/components/FileThumbnail.tsx
  - src/shared/components/FileList.tsx
  - src/shared/components/FilePreview.tsx
  - src/app/api/files/thumbnail/[...path]/route.ts
  - src/shared/components/index.ts

autonomous: true

must_haves:
  truths:

```
- "User can see thumbnails for image attachments"
- "User can see file type icons for non-image files"
- "User can click to download files"
- "File list shows size and type information"

```
  artifacts:

```
- path: "src/shared/components/FileThumbnail.tsx"

  provides: "Thumbnail display with fallback icons"
  min_lines: 60

- path: "src/shared/components/FileList.tsx"

  provides: "List view of file attachments"
  min_lines: 80

- path: "src/app/api/files/thumbnail/[...path]/route.ts"

  provides: "Thumbnail serving endpoint"
  exports: ["GET"]

```
  key_links:

```
- from: "src/shared/components/FileThumbnail.tsx"

  to: "/api/files/thumbnail"
  via: "img src"
  pattern: "api/files/thumbnail"

```
---

<objective>
Create file display components for showing thumbnails, file lists, and preview
functionality.

Purpose: Users need to see their attached files with visual previews for images
and clear file type indicators for documents. This provides the visual feedback
that makes file attachments useful.

Output: FileThumbnail.tsx, FileList.tsx, FilePreview.tsx components, thumbnail
serving endpoint
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-file-attachments/05-CONTEXT.md
@src/shared/lib/file-validation.ts
@src/shared/components/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thumbnail serving endpoint</name>
  <files>src/app/api/files/thumbnail/[...path]/route.ts</files>
  <action>
Create src/app/api/files/thumbnail/[...path]/route.ts:

```typescript

import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/shared/lib/auth'
import path from 'path'
import fs from 'fs/promises'

/**

 * Serve thumbnail files with authentication.
 * Path format: /api/files/thumbnail/userId/taskId/thumbs/filename.webp

 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ path: string[] }> }
) {
  try {

```
// Authenticate
const session = await auth()
if (!session?.user?.id) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}

const { path: pathSegments } = await params

// Validate path segments
if (!pathSegments || pathSegments.length < 4) {
  return NextResponse.json({ error: 'Invalid path' }, { status: 400 })
}

// Extract userId from path and verify ownership
const [userId] = pathSegments
if (userId !== session.user.id) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

// Construct full path
const thumbnailPath = path.join(process.cwd(), 'uploads', ...pathSegments)

// Security: Prevent path traversal
const normalizedPath = path.normalize(thumbnailPath)
const uploadsDir = path.join(process.cwd(), 'uploads')
if (!normalizedPath.startsWith(uploadsDir)) {
  return NextResponse.json({ error: 'Invalid path' }, { status: 400 })
}

// Read thumbnail
try {
  const buffer = await fs.readFile(normalizedPath)

  return new NextResponse(buffer, {
    status: 200,
    headers: {
      'Content-Type': 'image/webp',
      'Cache-Control': 'private, max-age=86400', // Cache for 24 hours
    },
  })
} catch {
  return NextResponse.json({ error: 'Thumbnail not found' }, { status: 404 })
}

```
  } catch (error) {

```
console.error('Thumbnail serving error:', error)
return NextResponse.json({ error: 'Internal server error' }, { status: 500 })

```
  }
}

```html

  </action>
  <verify>
Check file exists: `ls src/app/api/files/thumbnail/`
Run `npx tsc --noEmit` to verify TypeScript compiles.
  </verify>
  <done>

- Thumbnail endpoint at /api/files/thumbnail/[...path]
- Authentication required
- Ownership verification via userId in path
- Path traversal protection
- 24-hour cache headers

  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileThumbnail and FilePreview components</name>
  <files>src/shared/components/FileThumbnail.tsx,
  src/shared/components/FilePreview.tsx</files>
  <action>
Create src/shared/components/FileThumbnail.tsx:

```tsx

'use client'

import { useState } from 'react'
import Image from 'next/image'

interface FileThumbnailProps {
  filename: string
  mimeType: string
  thumbnailPath?: string | null
  size?: 'sm' | 'md' | 'lg'
  onClick?: () => void
}

export function FileThumbnail({
  filename,
  mimeType,
  thumbnailPath,
  size = 'md',
  onClick,
}: FileThumbnailProps) {
  const [imageError, setImageError] = useState(false)

  const sizeClasses = {

```
sm: 'w-10 h-10',
md: 'w-16 h-16',
lg: 'w-24 h-24',

```
  }

  const iconSizes = {

```
sm: 'w-5 h-5',
md: 'w-8 h-8',
lg: 'w-12 h-12',

```
  }

  const isImage = mimeType.startsWith('image/')
  const hasThumbnail = thumbnailPath && !imageError

  // Show image thumbnail
  if (isImage && hasThumbnail) {

```
return (
  <button
    onClick={onClick}
    className={`${sizeClasses[size]} relative rounded-lg overflow-hidden bg-zinc-800 border border-zinc-700 hover:border-zinc-500 transition-colors`}
  >
    <Image
      src={`/api/files/thumbnail/${thumbnailPath}`}
      alt={filename}
      fill
      className="object-cover"
      onError={() => setImageError(true)}
      sizes={size === 'lg' ? '96px' : size === 'md' ? '64px' : '40px'}
    />
  </button>
)

```
  }

  // Show file type icon
  return (

```
<button
  onClick={onClick}
  className={`${sizeClasses[size]} flex items-center justify-center rounded-lg bg-zinc-800 border border-zinc-700 hover:border-zinc-500 transition-colors`}
>
  <FileTypeIcon mimeType={mimeType} className={iconSizes[size]} />
</button>

```
  )
}

// File type icon based on MIME type
function FileTypeIcon({ mimeType, className }: { mimeType: string; className?: string }) {
  const isPdf = mimeType === 'application/pdf'
  const isDoc = mimeType.includes('word') || mimeType.includes('document')
  const isSpreadsheet = mimeType.includes('excel') || mimeType.includes('spreadsheet')
  const isPresentation = mimeType.includes('powerpoint') || mimeType.includes('presentation')
  const isArchive = mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('gzip')
  const isImage = mimeType.startsWith('image/')
  const isText = mimeType.startsWith('text/')

  // Choose color based on type
  let color = 'text-zinc-400'
  if (isPdf) color = 'text-red-400'
  else if (isDoc) color = 'text-blue-400'
  else if (isSpreadsheet) color = 'text-green-400'
  else if (isPresentation) color = 'text-orange-400'
  else if (isArchive) color = 'text-yellow-400'
  else if (isImage) color = 'text-purple-400'
  else if (isText) color = 'text-zinc-300'

  return (

```
<svg className={`${className} ${color}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
  {isPdf ? (
    // PDF icon
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  ) : isImage ? (
    // Image icon
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
  ) : isArchive ? (
    // Archive icon
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
  ) : (
    // Generic document icon
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
  )}
</svg>

```
  )
}

// Export FileTypeIcon for use elsewhere
export { FileTypeIcon }

```

Create src/shared/components/FilePreview.tsx:

```tsx

'use client'

import { useEffect, useCallback } from 'react'
import { formatFileSize } from '@/shared/lib/file-validation'

interface FilePreviewProps {
  fileId: string
  filename: string
  mimeType: string
  size: number
  onClose: () => void
  onDownload: () => void
  onDelete?: () => void
}

export function FilePreview({
  fileId,
  filename,
  mimeType,
  size,
  onClose,
  onDownload,
  onDelete,
}: FilePreviewProps) {
  const isImage = mimeType.startsWith('image/')
  const isPdf = mimeType === 'application/pdf'

  // Handle escape key
  const handleKeyDown = useCallback((e: KeyboardEvent) => {

```
if (e.key === 'Escape') {
  onClose()
}

```
  }, [onClose])

  useEffect(() => {

```
document.addEventListener('keydown', handleKeyDown)
return () => document.removeEventListener('keydown', handleKeyDown)

```
  }, [handleKeyDown])

  // Prevent body scroll when modal is open
  useEffect(() => {

```
document.body.style.overflow = 'hidden'
return () => {
  document.body.style.overflow = 'unset'
}

```
  }, [])

  return (

```
<div
  className="fixed inset-0 z-50 flex items-center justify-center bg-black/80"
  onClick={onClose}
>
  <div
    className="bg-zinc-900 rounded-lg shadow-xl max-w-4xl max-h-[90vh] w-full mx-4 flex flex-col"
    onClick={(e) => e.stopPropagation()}
  >
    {/* Header */}
    <div className="flex items-center justify-between px-4 py-3 border-b border-zinc-700">
      <div className="min-w-0 flex-1">
        <h3 className="text-lg font-medium text-zinc-100 truncate">{filename}</h3>
        <p className="text-sm text-zinc-400">{formatFileSize(size)}</p>
      </div>

      <div className="flex items-center gap-2 ml-4">
        <button
          onClick={onDownload}
          className="px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
        >
          Download
        </button>
        {onDelete && (
          <button
            onClick={onDelete}
            className="px-3 py-1.5 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
          >
            Delete
          </button>
        )}
        <button
          onClick={onClose}
          className="p-1.5 text-zinc-400 hover:text-zinc-200 transition-colors"
        >
          <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    {/* Content */}
    <div className="flex-1 overflow-auto p-4 flex items-center justify-center min-h-[300px]">
      {isImage ? (
        // eslint-disable-next-line @next/next/no-img-element
        <img
          src={`/api/files/download/${fileId}`}
          alt={filename}
          className="max-w-full max-h-full object-contain"
        />
      ) : isPdf ? (
        <iframe
          src={`/api/files/download/${fileId}`}
          className="w-full h-full min-h-[500px]"
          title={filename}
        />
      ) : (
        <div className="text-center">
          <svg
            className="w-20 h-20 mx-auto text-zinc-500 mb-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={1}
              d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
            />
          </svg>
          <p className="text-zinc-400 mb-4">Preview not available for this file type</p>
          <button
            onClick={onDownload}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            Download to view
          </button>
        </div>
      )}
    </div>
  </div>
</div>

```
  )
}

```html

  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check files: `ls src/shared/components/File*.tsx`
  </verify>
  <done>

- FileThumbnail shows image thumbnails or file type icons
- FileTypeIcon provides visual indicators for different file types
- FilePreview modal for viewing files
- Image preview inline, PDF in iframe, others show download
- Keyboard navigation (Escape to close)

  </done>
</task>

<task type="auto">
  <name>Task 3: Create FileList component and update exports</name>
  <files>src/shared/components/FileList.tsx,
  src/shared/components/index.ts</files>
  <action>
Create src/shared/components/FileList.tsx:

```tsx

'use client'

import { useState, useTransition } from 'react'
import { FileAttachment } from '@prisma/client'
import { FileThumbnail } from './FileThumbnail'
import { FilePreview } from './FilePreview'
import { formatFileSize } from '@/shared/lib/file-validation'
import { deleteFileAction } from '@/app/actions/files'

interface FileListProps {
  files: FileAttachment[]
  onFileDeleted?: (fileId: string) => void
  editable?: boolean
  compact?: boolean
}

export function FileList({
  files,
  onFileDeleted,
  editable = false,
  compact = false,
}: FileListProps) {
  const [previewFile, setPreviewFile] = useState<FileAttachment | null>(null)
  const [isPending, startTransition] = useTransition()
  const [deletingId, setDeletingId] = useState<string | null>(null)

  if (files.length === 0) {

```
return null

```
  }

  const handleDownload = (file: FileAttachment) => {

```
window.open(`/api/files/download/${file.id}`, '_blank')

```
  }

  const handleDelete = async (file: FileAttachment) => {

```
if (!confirm(`Delete "${file.filename}"? This cannot be undone.`)) {
  return
}

setDeletingId(file.id)
startTransition(async () => {
  const result = await deleteFileAction(file.id)
  if (result.success) {
    onFileDeleted?.(file.id)
    if (previewFile?.id === file.id) {
      setPreviewFile(null)
    }
  } else {
    alert(result.error || 'Failed to delete file')
  }
  setDeletingId(null)
})

```
  }

  // Compact grid view (for task cards)
  if (compact) {

```
return (
  <div className="flex flex-wrap gap-2">
    {files.slice(0, 4).map((file) => (
      <FileThumbnail
        key={file.id}
        filename={file.filename}
        mimeType={file.mimeType}
        thumbnailPath={file.thumbnailPath}
        size="sm"
        onClick={() => setPreviewFile(file)}
      />
    ))}
    {files.length > 4 && (
      <div className="w-10 h-10 flex items-center justify-center rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-400 text-xs">
        +{files.length - 4}
      </div>
    )}

    {/* Preview modal */}
    {previewFile && (
      <FilePreview
        fileId={previewFile.id}
        filename={previewFile.filename}
        mimeType={previewFile.mimeType}
        size={previewFile.size}
        onClose={() => setPreviewFile(null)}
        onDownload={() => handleDownload(previewFile)}
      />
    )}
  </div>
)

```
  }

  // Full list view (for edit page)
  return (

```
<div className="space-y-2">
  {files.map((file) => (
    <div
      key={file.id}
      className={`flex items-center gap-3 p-3 rounded-lg bg-zinc-800/50 border border-zinc-700 ${
        deletingId === file.id ? 'opacity-50' : ''
      }`}
    >
      <FileThumbnail
        filename={file.filename}
        mimeType={file.mimeType}
        thumbnailPath={file.thumbnailPath}
        size="md"
        onClick={() => setPreviewFile(file)}
      />

      <div className="flex-1 min-w-0">
        <p className="text-sm text-zinc-200 truncate">{file.filename}</p>
        <p className="text-xs text-zinc-500">
          {formatFileSize(file.size)}
        </p>
      </div>

      <div className="flex items-center gap-2">
        <button
          onClick={() => handleDownload(file)}
          className="p-1.5 text-zinc-400 hover:text-zinc-200 transition-colors"
          title="Download"
        >
          <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
        </button>

        {editable && (
          <button
            onClick={() => handleDelete(file)}
            disabled={isPending}
            className="p-1.5 text-red-400 hover:text-red-300 transition-colors disabled:opacity-50"
            title="Delete"
          >
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        )}
      </div>
    </div>
  ))}

  {/* Preview modal */}
  {previewFile && (
    <FilePreview
      fileId={previewFile.id}
      filename={previewFile.filename}
      mimeType={previewFile.mimeType}
      size={previewFile.size}
      onClose={() => setPreviewFile(null)}
      onDownload={() => handleDownload(previewFile)}
      onDelete={editable ? () => handleDelete(previewFile) : undefined}
    />
  )}
</div>

```
  )
}

// File count badge for task cards
export function FileCountBadge({ count }: { count: number }) {
  if (count === 0) return null

  return (

```
<div className="flex items-center gap-1 text-xs text-zinc-400">
  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
  </svg>
  <span>{count}</span>
</div>

```
  )
}

```

Update src/shared/components/index.ts to add new exports:

```typescript

// Existing exports
export { ProfileForm } from './ProfileForm'
export { TaskCard } from './TaskCard'
export { TaskEditForm } from './TaskEditForm'
export { TaskForm } from './TaskForm'
export { TaskList } from './TaskList'
export { UserMenu } from './UserMenu'
export { TagBadge } from './TagBadge'
export { TagInput } from './TagInput'
export { TaskFilters } from './TaskFilters'
export { TaskSearchBar } from './TaskSearchBar'
export { TaskFormWithTags } from './TaskFormWithTags'
export { TaskEditFormWithTags } from './TaskEditFormWithTags'
export { TaskListWithFilters } from './TaskListWithFilters'
export { EmptyState } from './EmptyState'

// File upload components
export { FileDropzone } from './FileDropzone'
export { FileUploadProgress } from './FileUploadProgress'
export type { UploadState, UploadStatus } from './FileUploadProgress'

// File display components
export { FileThumbnail, FileTypeIcon } from './FileThumbnail'
export { FilePreview } from './FilePreview'
export { FileList, FileCountBadge } from './FileList'

```html

  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check all exports: `grep "export" src/shared/components/index.ts`
  </verify>
  <done>

- FileList shows files in list or compact grid view
- Download and delete actions available
- FilePreview modal integrated
- FileCountBadge for task card indicators
- All new components exported from index

  </done>
</task>

</tasks>

<verification>

1. Run `npx tsc --noEmit` - no TypeScript errors
2. Run `npm run build` - verify build succeeds
3. Check all file components exist and export correctly
4. Verify thumbnail endpoint is created

</verification>

<success_criteria>

- FileThumbnail shows WebP thumbnails for images
- FileTypeIcon provides visual indicators for file types
- FilePreview modal displays images/PDFs inline
- FileList shows all attachments with actions
- FileCountBadge provides compact file count indicator
- Thumbnail API route serves files with auth
- All components exported from index

</success_criteria>

<output>
After completion, create `.planning/phases/05-file-attachments/05-05-SUMMARY.md`
</output>
