---
phase: 05-file-attachments
plan: 06
type: execute
wave: 5
depends_on: ["05-03", "05-04", "05-05"]
files_modified:

  - src/shared/components/TaskCard.tsx
  - src/shared/components/TaskEditFormWithTags.tsx
  - src/shared/components/TaskFormWithTags.tsx
  - src/app/(app)/tasks/[id]/edit/page.tsx
  - src/shared/lib/dal.ts

autonomous: true

must_haves:
  truths:

```markdown

- "Task cards show file attachment indicators"
- "Task edit form includes file upload area"
- "Files can be managed from task edit page"
- "File count updates when files are added/removed"

```yaml

  artifacts:

```yaml

- path: "src/shared/components/TaskCard.tsx"

  provides: "Task card with file count indicator"
  contains: "FileCountBadge"

- path: "src/shared/components/TaskEditFormWithTags.tsx"

  provides: "Task edit form with file upload and list"
  contains: "FileDropzone"

```yaml

  key_links:

```yaml

- from: "src/shared/components/TaskCard.tsx"

  to: "FileCountBadge"
  via: "component import"
  pattern: "FileCountBadge"

- from: "src/shared/components/TaskEditFormWithTags.tsx"

  to: "FileDropzone"
  via: "component import"
  pattern: "FileDropzone"

- from: "src/shared/lib/dal.ts"

  to: "prisma.fileAttachment"
  via: "DAL queries"
  pattern: "fileAttachment\\.(findMany|count)"

```html

---

<objective>
Integrate file attachment components into existing task UI (cards, forms,
pages).

Purpose: Connect the file upload functionality to the task management workflow.
Users should see file indicators on task cards and be able to manage files from
the task edit page.

Output: Updated TaskCard with file indicator, TaskEditFormWithTags with file
management, updated edit page
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-file-attachments/05-CONTEXT.md
@src/shared/components/TaskCard.tsx
@src/shared/components/TaskEditFormWithTags.tsx
@src/app/(app)/tasks/[id]/edit/page.tsx
@src/shared/lib/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TaskCard to show file indicators</name>
  <files>src/shared/components/TaskCard.tsx</files>
  <action>
Update src/shared/components/TaskCard.tsx to include file count indicator.

Read the existing TaskCard.tsx first, then modify to:

1. Add import for FileCountBadge:

```typescript

import { FileCountBadge } from './FileList'

```yaml

2. Update the component props to accept file count (or attachments array):

```typescript

interface TaskCardProps {
  task: Task & { tags: Tag[], attachments?: { id: string }[] }
  onStatusChange?: (taskId: string, status: TaskStatus) => void
}

```yaml

3. Add FileCountBadge in the card footer area (near the date or tags):

```tsx

{/* File attachment indicator */}
{task.attachments && task.attachments.length > 0 && (
  <FileCountBadge count={task.attachments.length} />
)}

```python

Place it after the tags display or in the card's metadata area. The indicator
should be subtle but visible.

Important: The TaskCard receives task data from parent components. Update the
data fetching in parent components (like TaskList or pages) to include
attachments count:

```prisma

// In DAL or page queries
include: {
  tags: true,
  attachments: {

```

select: { id: true } // Only need count, not full data

```text
  }
}

```html

  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check TaskCard: `grep -n "FileCountBadge" src/shared/components/TaskCard.tsx`
  </verify>
  <done>

- TaskCard imports and renders FileCountBadge
- File count shows when task has attachments
- Indicator is subtle but visible
- Props updated to accept attachments array

  </done>
</task>

<task type="auto">
  <name>Task 2: Update TaskEditFormWithTags to include file management</name>
  <files>src/shared/components/TaskEditFormWithTags.tsx</files>
  <action>
Update src/shared/components/TaskEditFormWithTags.tsx to add file upload and
list.

Read the existing file first, then modify to:

1. Add imports:

```typescript

import { FileDropzone } from './FileDropzone'
import { FileList } from './FileList'
import { FileAttachment } from '@prisma/client'

```yaml

2. Update props to accept initial files:

```typescript

interface TaskEditFormWithTagsProps {
  task: {

```yaml

id: string
title: string
description: string | null
status: TaskStatus
tags: Tag[]
attachments?: FileAttachment[]

```yaml
  }
  userTags: Tag[]
}

```yaml

3. Add state for files:

```typescript

const [files, setFiles] = useState<FileAttachment[]>(task.attachments || [])

```yaml

4. Add handlers:

```typescript

const handleUploadComplete = useCallback((fileId: string, filename: string) => {
  // Refresh the page to get updated file list
  // Or optimistically add the file (requires full file data)
  router.refresh()
}, [router])

const handleFileDeleted = useCallback((fileId: string) => {
  setFiles(prev => prev.filter(f => f.id !== fileId))
}, [])

```yaml

5. Add file section after the form fields (before or after tags):

```tsx

{/* File Attachments Section */}
<div className="space-y-3">
  <label className="block text-sm font-medium text-zinc-300">

```text

Attachments

```
  </label>

  {/* Existing files */}
  <FileList

```text

files={files}
onFileDeleted={handleFileDeleted}
editable={true}

```text
  />

  {/* Upload new files */}
  <FileDropzone

```text

taskId={task.id}
onUploadComplete={handleUploadComplete}
compact={true}

```html

  />
</div>

```python

6. Add useRouter import if not present:

```typescript

import { useRouter } from 'next/navigation'

// In component:
const router = useRouter()

```html

  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check imports: `grep -n "FileDropzone\|FileList"
src/shared/components/TaskEditFormWithTags.tsx`
  </verify>
  <done>

- TaskEditFormWithTags has FileDropzone for uploads
- FileList shows existing attachments
- Delete works inline
- Upload complete triggers page refresh
- Compact dropzone fits form layout

  </done>
</task>

<task type="auto">
  <name>Task 3: Update edit page and DAL to fetch and pass file data</name>
  <files>src/app/(app)/tasks/[id]/edit/page.tsx, src/shared/lib/dal.ts</files>
  <action>
Update the edit page to fetch task with attachments.

1. First, update DAL if needed. The `getTaskWithFiles` function already exists

from Plan 05-03. Use it instead of `getTaskWithTags`.

2. Update src/app/(app)/tasks/[id]/edit/page.tsx:

```typescript

import { verifySession, getTaskWithFiles, getTagsByUser } from '@/shared/lib/dal'
// Change from getTaskWithTags to getTaskWithFiles

// In the page component:
export default async function EditTaskPage({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const { userId } = await verifySession()
  const { id } = await params

  // Fetch task with both tags AND attachments
  const task = await getTaskWithFiles(id, userId)

  if (!task) {

```javascript

notFound()

```javascript
  }

  const userTags = await getTagsByUser(userId)

  return (

```

// ... existing layout ...
<TaskEditFormWithTags
  task={{

```yaml
...task,
attachments: task.attachments,

```yaml

  }}
  userTags={userTags}
/>

```yaml
  )
}

```yaml

3. Also update the TaskList/TaskCard data fetching to include attachment counts.

Update `getTasksByUser` in dal.ts to include attachments:

```typescript

export const getTasksByUser = cache(async (userId: string) => {
  try {

```javascript

const tasks = await prisma.task.findMany({
  where: { userId },
  include: {

```
tags: true,
attachments: {
  select: { id: true } // Only need IDs for count
}

```yaml

  },
  orderBy: [

```json
{ status: 'asc' },
{ createdAt: 'desc' }

```text

  ]
})

return tasks

```text
  } catch (error) {

```

console.error('Error fetching user tasks:', error)
return []

```text
  }
})

```yaml

Note: This task depends on Plan 05-03 which already added the file-related DAL
functions (getFilesByTask, getFile, getTaskFileCount, getTaskWithFiles). This
task modifies the existing `getTasksByUser` function to include attachments for
TaskCard display.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Run `npm run build` to verify build succeeds.
Check page: `grep -n "getTaskWithFiles" src/app/(app)/tasks/*/edit/page.tsx`
  </verify>
  <done>

- Edit page fetches task with attachments
- TaskEditFormWithTags receives file data
- getTasksByUser includes attachment IDs for count
- TaskCard can display file counts

  </done>
</task>

</tasks>

<verification>

1. Run `npx tsc --noEmit` - no TypeScript errors
2. Run `npm run build` - verify build succeeds
3. Verify all integration points are connected

</verification>

<success_criteria>

- TaskCard shows file count badge when task has attachments
- Task edit page loads with existing attachments displayed
- FileDropzone on edit page allows adding new files
- Delete files from edit page works
- File count updates after add/delete operations
- All data fetching includes necessary attachment data

</success_criteria>

<output>
After completion, create `.planning/phases/05-file-attachments/05-06-SUMMARY.md`
</output>
