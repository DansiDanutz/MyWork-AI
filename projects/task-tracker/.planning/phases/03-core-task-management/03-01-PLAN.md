---
phase: 03-core-task-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:

  - prisma/schema.prisma
  - src/app/actions/tasks.ts
  - src/shared/lib/dal.ts

autonomous: true

must_haves:
  truths:

```markdown

- "Task model exists in database with user ownership"
- "Server Actions can create, update, and delete tasks"
- "DAL can retrieve tasks for authenticated user"

```yaml

  artifacts:

```yaml

- path: "prisma/schema.prisma"

  provides: "Task model with status enum"
  contains: "model Task"

- path: "src/app/actions/tasks.ts"

  provides: "CRUD Server Actions"
  exports: ["createTask", "updateTask", "updateTaskStatus", "deleteTask"]

- path: "src/shared/lib/dal.ts"

  provides: "Task data access functions"
  exports: ["getTasksByUser", "getTask"]

```

  key_links:

```yaml

- from: "src/app/actions/tasks.ts"

  to: "prisma.task"
  via: "database operations"
  pattern: "prisma\\.task\\.(create|update|delete|findFirst)"

- from: "src/shared/lib/dal.ts"

  to: "prisma.task"
  via: "cached queries"
  pattern: "prisma\\.task\\.findMany"

```html

---

<objective>
Create the database foundation and server-side logic for task management.

Purpose: Establish the data layer and Server Actions that all UI components will
depend on. This is the foundation for all task CRUD operations.

Output: Task model in Prisma schema, CRUD Server Actions with Zod validation,
and DAL functions for retrieving tasks.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-task-management/03-RESEARCH.md
@prisma/schema.prisma
@src/app/actions/profile.ts
@src/shared/lib/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Task model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the Task model to the existing Prisma schema. The model must:

1. Define Task model with these fields:
   - id: String @id @default(cuid())
   - title: String (required, will validate length in Server Action)
   - description: String? @db.Text (optional, for longer descriptions)
   - status: String @default("todo") - values: "todo", "in_progress", "done"
   - userId: String (foreign key)
   - createdAt: DateTime @default(now())
   - updatedAt: DateTime @updatedAt

2. Add relation to User:
   - user: User @relation(fields: [userId], references: [id], onDelete: Cascade)

3. Add indexes for performance (critical for filtering):
   - @@index([userId, status]) - Fast user + status filtering
   - @@index([userId, createdAt]) - Fast chronological queries

4. Update User model to add tasks relation:
   - tasks: Task[]

After modifying schema, run:

- `npx prisma generate` - Regenerate client
- `npx prisma db push` - Push changes to database

Note: Using String for status instead of enum allows flexibility without
migrations when adding new statuses later. Validation happens in Server Actions.
  </action>
  <verify>
Run `npx prisma validate` - Should pass with no errors
Run `npx prisma db push` - Should succeed
Run `npx prisma studio` - Can verify Task model exists (optional)
  </verify>
  <done>Task model exists in database schema with user relation, and Prisma
  client is regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Create task Server Actions with Zod validation</name>
  <files>src/app/actions/tasks.ts</files>
  <action>
Create Server Actions for task CRUD following the pattern from profile.ts.

1. Create file `src/app/actions/tasks.ts` with:

```typescript

'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { z } from 'zod'
import { verifySession } from '@/shared/lib/dal'
import { prisma } from '@/shared/lib/db'

```yaml

2. Define validation schemas:
   - createTaskSchema: title (string, 1-200 chars, required), description

```text
 (string, max 2000, optional)

```

   - updateTaskSchema: title (string, 1-200 chars, optional), description

```text
 (string, max 2000, optional)

```yaml

   - statusSchema: enum ['todo', 'in_progress', 'done']

3. Define result types:

```typescript

export type TaskActionResult = {
  success: boolean
  error?: string
  taskId?: string
}

```yaml

4. Implement createTask(formData: FormData):
   - Verify session (get userId)
   - Extract and validate title, description from formData
   - Create task with status 'todo'
   - Track analytics event (task_created)
   - revalidatePath('/tasks')
   - redirect('/tasks') - OUTSIDE try/catch block (redirect throws)

5. Implement updateTask(taskId: string, formData: FormData):
   - Verify session
   - First verify task exists AND belongs to user (security check)
   - Validate fields
   - Update task
   - revalidatePath('/tasks')
   - Return success/error

6. Implement updateTaskStatus(taskId: string, status: string):
   - Verify session
   - Validate status with statusSchema
   - Verify task ownership
   - Update only status field
   - Track analytics (task_status_changed with from/to status)
   - revalidatePath('/tasks')
   - Return success/error

7. Implement deleteTask(taskId: string):
   - Verify session
   - Use prisma.task.deleteMany with WHERE id AND userId (security)
   - Check result.count === 0 means not found
   - Track analytics (task_deleted)
   - revalidatePath('/tasks')
   - Return success/error

IMPORTANT patterns from profile.ts to follow:

- Always call verifySession() first
- Use Zod safeParse for validation
- Return { success: false, error: '...' } on validation failure
- Use revalidatePath after mutations
- console.error for server-side logging
- Keep redirect() OUTSIDE try/catch (it throws a special error)

  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
All functions are exported and can be imported
  </verify>
  <done>All task CRUD Server Actions are implemented with proper validation,
  authorization, and cache revalidation</done>
</task>

<task type="auto">
  <name>Task 3: Extend DAL with task query functions</name>
  <files>src/shared/lib/dal.ts</files>
  <action>
Add task query functions to the existing DAL, following the getUser pattern.

Add to src/shared/lib/dal.ts:

1. Import Task type from Prisma:

```typescript

// Add to existing imports if not present
import type { Task } from '@prisma/client'

```yaml

2. Add getTasksByUser function:

```typescript

/**

 * Get all tasks for the authenticated user, ordered by status then date.
 * Uses React cache() to prevent duplicate queries in same request.

 */
export const getTasksByUser = cache(async (): Promise<Task[]> => {
  const { userId } = await verifySession()

  const tasks = await prisma.task.findMany({

```

where: { userId },
orderBy: [
  { status: 'asc' }, // Group by status (done, in_progress, todo alphabetically)
  { createdAt: 'desc' },  // Newest first within status
],

```text
  })

  return tasks
})

```yaml

3. Add getTask function:

```typescript

/**

 * Get a single task by ID, verifying user ownership.
 * Returns null if task doesn't exist or doesn't belong to user.

 */
export const getTask = cache(async (taskId: string): Promise<Task | null> => {
  const { userId } = await verifySession()

  const task = await prisma.task.findFirst({

```yaml

where: {
  id: taskId,
  userId,  // Security: Only return if user owns it
},

```
  })

  return task
})

```python

Note: Using findFirst with both id and userId is intentional - it prevents users
from accessing tasks they don't own even if they guess IDs.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Functions are properly cached with React cache()
  </verify>
  <done>DAL exports getTasksByUser and getTask functions with proper caching and
  authorization</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema validation:
   - `npx prisma validate` passes
   - Task model has all required fields and indexes

2. Type checking:
   - `npx tsc --noEmit` passes
   - No TypeScript errors in actions/tasks.ts or dal.ts

3. Import verification:
   - All exports accessible: createTask, updateTask, updateTaskStatus,

```text
 deleteTask, getTasksByUser, getTask

```yaml

4. Database state:
   - Prisma client regenerated
   - Schema pushed to database

</verification>

<success_criteria>

- Task model exists in Prisma schema with User relation
- All CRUD Server Actions are implemented with Zod validation
- DAL has getTasksByUser and getTask functions
- All code compiles without TypeScript errors
- Database schema is pushed and Prisma client regenerated

</success_criteria>

<output>
After completion, create
`.planning/phases/03-core-task-management/03-01-SUMMARY.md`
</output>
