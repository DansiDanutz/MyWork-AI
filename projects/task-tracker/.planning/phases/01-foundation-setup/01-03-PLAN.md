---
phase: 01-foundation-setup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:

  - .env
  - .env.example
  - src/shared/lib/env.ts

autonomous: true
gap_closure: true

must_haves:
  truths:

```markdown

- "npm run build completes without errors"
- "npm run dev still starts successfully"
- "Environment validation still works for required variables"

```yaml

  artifacts:

```yaml

- path: ".env"

  provides: "Environment configuration without NODE_ENV"
  contains: "DATABASE_URL"

- path: ".env.example"

  provides: "Environment template without NODE_ENV"
  contains: "DATABASE_URL"

- path: "src/shared/lib/env.ts"

  provides: "Environment validation without NODE_ENV requirement"
  contains: "envSchema"

```

  key_links:

```yaml

- from: "src/shared/lib/env.ts"

  to: "process.env"
  via: "Zod validation"
  pattern: "envSchema\\.safeParse"

```html

---

<objective>
Fix the Next.js build failure caused by NODE_ENV conflict in environment
configuration.

Purpose: Close the verification gap that prevents production builds from
succeeding. The build currently fails with "Html should not be imported outside
of pages/_document" error when NODE_ENV=development is set in .env during `npm
run build`.

Output: Production build (`npm run build`) completes successfully without
workarounds, while development workflow remains unaffected.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
@.planning/phases/01-foundation-setup/01-02-SUMMARY.md
@.planning/phases/01-foundation-setup/01-VERIFICATION.md
</context>

<gap_being_closed>
**Truth:** "Development server starts without errors and serves base
application"
**Status:** Partial - dev server works, but `npm run build` fails

**Root Cause Analysis:**

1. `.env` file contains `NODE_ENV="development"`
2. During `npm run build`, Next.js sets NODE_ENV to "production" internally
3. The value from `.env` conflicts, causing "non-standard NODE_ENV value"

warning

4. This triggers a code path in Next.js that incorrectly renders Pages Router

error pages

5. The Pages Router error pages try to import `<Html>` outside of

`_document.tsx`, causing the build failure

**Evidence:**

- `npm run build` fails with: "Error: <Html> should not be imported outside of

  pages/_document"

- `unset NODE_ENV && npm run build` succeeds (confirms NODE_ENV is the cause)
- Build output shows: "You are using a non-standard NODE_ENV value in your

  environment"

**Fix Strategy:**
Remove NODE_ENV from .env files - Next.js manages this automatically based on
the command being run (dev = development, build/start = production). The env.ts
validation should not require NODE_ENV since it's always provided by the
runtime.
</gap_being_closed>

<tasks>

<task type="auto">
  <name>Task 1: Remove NODE_ENV from Environment Files</name>
  <files>

```text
.env
.env.example

```

  </files>
  <action>

```yaml
Update both environment files to remove NODE_ENV:

1. Edit `.env` to contain only:

```markdown

```markdown

```markdown

   # Database

   DATABASE_URL="postgresql://dansidanutz@localhost:5432/tasktracker?schema=public"

   # App URL (client-exposed)

   NEXT_PUBLIC_APP_URL="<http://localhost:3000">

   ```

2. Edit `.env.example` to contain only:

```text

```markdown

```markdown

   # Database

   DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tasktracker?schema=public"

   # App URL (client-exposed)

   NEXT_PUBLIC_APP_URL="<http://localhost:3000">

```yaml

DO NOT add NODE_ENV back - Next.js sets this automatically:

- `npm run dev` sets NODE_ENV=development
- `npm run build` and `npm run start` set NODE_ENV=production
- Tests can set NODE_ENV=test as needed

Add a comment in .env.example explaining this:

```

```markdown

```markdown

# Note: NODE_ENV is managed by Next.js automatically

# - dev: development

# - build/start: production

# Do not set NODE_ENV in this file

```html

```html

  </action>
  <verify>

```

1. `cat .env | grep -c NODE_ENV` returns 0 (no NODE_ENV line)
2. `cat .env.example | grep -c NODE_ENV` returns 0 (no NODE_ENV line)
3. `.env` still contains DATABASE_URL and NEXT_PUBLIC_APP_URL

```html

  </verify>
  <done>

```html

Environment files no longer contain NODE_ENV, preventing conflict with
Next.js build process.

```html

  </done>
</task>

<task type="auto">
  <name>Task 2: Update Environment Validation Schema</name>
  <files>

```
src/shared/lib/env.ts

```html

  </files>
  <action>

```yaml
Update the Zod schema to not require NODE_ENV validation since Next.js
manages it automatically.

Replace the current env.ts content with:

```typescript

import { z } from 'zod'

const envSchema = z.object({
  // Database
  DATABASE_URL: z.string().url().startsWith('postgresql://'),

  // App URL (client-exposed)
  NEXT_PUBLIC_APP_URL: z.string().url().default('<http://localhost:3000'>),
})

// Validate at import time - fails fast if env is misconfigured
const parsed = envSchema.safeParse(process.env)

if (!parsed.success) {
  console.error('Invalid environment variables:')
  console.error(parsed.error.flatten().fieldErrors)
  throw new Error('Invalid environment configuration')
}

export const env = parsed.data

// NODE_ENV is managed by Next.js, access via process.env.NODE_ENV directly
// - 'development' during `npm run dev`
// - 'production' during `npm run build` and `npm run start`
export const isDev = process.env.NODE_ENV === 'development'
export const isProd = process.env.NODE_ENV === 'production'

```text

```yaml

```
This change:

- Removes NODE_ENV from the Zod schema (Next.js manages it)
- Adds helper exports `isDev` and `isProd` for convenience
- Keeps validation for user-controlled env vars (DATABASE_URL,

  NEXT_PUBLIC_APP_URL)

```html

  </action>
  <verify>

```markdown

1. `cat src/shared/lib/env.ts | grep -c "NODE_ENV"` shows lines exist (for

isDev/isProd helpers)

2. `cat src/shared/lib/env.ts | grep -c "envSchema.*NODE_ENV"` returns 0

(not in schema)

3. `npx tsc --noEmit` succeeds with no type errors

```html

  </verify>
  <done>

```
Environment validation schema no longer requires NODE_ENV, while providing
convenient isDev/isProd helpers.

```html

  </done>
</task>

<task type="auto">
  <name>Task 3: Update Health Check to Use New Env Helpers</name>
  <files>

```html

src/app/api/health/route.ts

```html

  </files>
  <action>

```
Update the health check endpoint to use the new isDev export and remove
dependency on env.NODE_ENV.

Read the current health route and update it to:

1. Import `isDev` from env.ts instead of `env.NODE_ENV`
2. Update the environment field to use process.env.NODE_ENV directly

The updated import should be:

```typescript

import { env, isDev } from '@/shared/lib/env'

```yaml

And the environment field should be:

```typescript

environment: process.env.NODE_ENV || 'unknown',

```text

```html

```text
This ensures the health endpoint still reports the current environment
correctly.

```

  </action>
  <verify>

```yaml

1. `npm run dev` and curl <http://localhost:3000/api/health> returns status

"ok"

2. Response includes `environment: "development"` (from

process.env.NODE_ENV)

3. `npx tsc --noEmit` succeeds

```html

  </verify>
  <done>

```text
Health check endpoint works with updated environment helpers.

```

  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the gap is closed:

1. **Production Build (THE KEY TEST):**

   ```bash
   npm run build

   # Should complete successfully WITHOUT any workarounds

   # No need to unset NODE_ENV anymore

```yaml

2. **Development Server:**

   ```bash
   npm run dev

   # Should still start at localhost:3000

   curl http://localhost:3000/api/health

   # Should return status "ok" with environment "development"

```yaml

3. **TypeScript Compilation:**

   ```bash
   npx tsc --noEmit

   # Should have no errors

```yaml

4. **Environment Validation Still Works:**

   ```bash

   # Test that missing required vars are caught

   # Create a test without DATABASE_URL

   DATABASE_URL="" npx tsx -e "import { env } from './src/shared/lib/env'" 2>&1 | head -5

   # Should show validation error for DATABASE_URL

```html

</verification>

<success_criteria>

- `npm run build` completes successfully without workarounds
- `npm run dev` starts successfully
- Health check endpoint returns correct environment status
- Environment validation catches missing DATABASE_URL
- No NODE_ENV in .env or .env.example files
- TypeScript compiles without errors

</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-03-SUMMARY.md`
</output>
