---
phase: 06-github-integration-analytics
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:

  - src/app/api/analytics/export/route.ts
  - src/shared/lib/analytics/queries.ts
  - src/shared/lib/analytics/retention.ts
  - src/shared/lib/analytics/index.ts

autonomous: true

must_haves:
  truths:

```markdown

- "Usage data can be exported for brain analysis"
- "Events older than 90 days can be purged for GDPR compliance"
- "Export endpoint requires authentication"
- "Queries support time-range filtering"

```yaml

  artifacts:

```yaml

- path: "src/app/api/analytics/export/route.ts"

  provides: "API endpoint for brain analysis export"
  exports: ["GET"]

- path: "src/shared/lib/analytics/queries.ts"

  provides: "Analytics query functions"
  exports: ["getUserEventTimeline", "getEventsByType",
  "exportEventsForBrain"]

- path: "src/shared/lib/analytics/retention.ts"

  provides: "GDPR-compliant data retention"
  exports: ["purgeExpiredEvents", "getRetentionStats"]

```

  key_links:

```yaml

- from: "src/app/api/analytics/export/route.ts"

  to: "src/shared/lib/analytics/queries.ts"
  via: "exportEventsForBrain function"
  pattern: "import.*exportEventsForBrain"

- from: "src/shared/lib/analytics/retention.ts"

  to: "prisma.analyticsEvent.deleteMany"
  via: "batch delete"
  pattern: "deleteMany"

```html

---

<objective>
Create analytics export API and data retention functionality for brain learning
integration.

Purpose: Enable the MyWork brain to consume usage data for pattern analysis,
while ensuring GDPR compliance through configurable data retention policies.
This completes the analytics infrastructure by making data accessible
externally.

Output: Export API endpoint for brain scripts, query functions for analytics
data, and retention utilities for data cleanup.
</objective>

<execution_context>
@/Users/dansidanutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dansidanutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-github-integration-analytics/06-RESEARCH.md

# Depends on Plan 01 and 02

@src/shared/lib/analytics/types.ts
@src/shared/lib/analytics/tracker.ts
@src/shared/lib/analytics/github.ts

# Existing patterns

@src/shared/lib/dal.ts
@src/app/api/health/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics query functions</name>
  <files>src/shared/lib/analytics/queries.ts</files>
  <action>
Create `src/shared/lib/analytics/queries.ts` with query functions for analytics
data:

```typescript

import 'server-only'
import { prisma } from '@/shared/lib/db'
import type { EventType } from './types'

/**

 * Get event timeline for a specific user.
 * Useful for user activity debugging and pattern analysis.

 *

 * @param userId - User ID to query
 * @param days - Number of days to look back (default 30)
 * @returns Array of events sorted by date descending

 */
export async function getUserEventTimeline(
  userId: string,
  days: number = 30
) {
  const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)

  return prisma.analyticsEvent.findMany({

```yaml

where: {
  userId,
  createdAt: {

```
gte: cutoffDate,

```yaml

  },
},
orderBy: { createdAt: 'desc' },
select: {
  id: true,
  eventType: true,
  properties: true,
  createdAt: true,
},

```
  })
}

/**

 * Get events by type with optional time range.
 * Useful for feature-specific analysis.

 *

 * @param eventType - Type of event to query
 * @param startDate - Start of date range (optional)
 * @param endDate - End of date range (optional)
 * @param limit - Maximum number of results (default 1000)

 */
export async function getEventsByType(
  eventType: EventType,
  startDate?: Date,
  endDate?: Date,
  limit: number = 1000
) {
  return prisma.analyticsEvent.findMany({

```yaml

where: {
  eventType,
  createdAt: {

```yaml
...(startDate ? { gte: startDate } : {}),
...(endDate ? { lte: endDate } : {}),

```

  },
},
orderBy: { createdAt: 'desc' },
take: limit,
select: {
  id: true,
  userId: true,
  properties: true,
  createdAt: true,
},

```markdown

  })
}

/**

 * Get aggregated feature usage statistics.
 * Uses raw SQL for efficient aggregation.

 *

 * @param eventType - Type of event to aggregate
 * @param days - Number of days to look back (default 30)

 */
export async function getFeatureUsageStats(eventType: EventType, days: number = 30) {
  const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)

  // Use Prisma's groupBy for aggregation
  const stats = await prisma.analyticsEvent.groupBy({

```yaml

by: ['eventType'],
where: {
  eventType,
  createdAt: { gte: cutoffDate },
},
_count: { id: true },

```
  })

  // Also get unique users
  const uniqueUsers = await prisma.analyticsEvent.findMany({

```yaml

where: {
  eventType,
  createdAt: { gte: cutoffDate },
},
distinct: ['userId'],
select: { userId: true },

```bash
  })

  return {

```bash

eventType,
totalEvents: stats[0]?._count.id || 0,
uniqueUsers: uniqueUsers.length,
period: { start: cutoffDate, end: new Date() },

```
  }
}

/**

 * Export events for brain analysis.
 * Optimized format for external analysis scripts.
 * Only includes user ID (not PII) for GDPR compliance.

 *

 * @param startDate - Start of export range
 * @param endDate - End of export range
 * @param eventTypes - Optional filter for specific event types

 */
export async function exportEventsForBrain(
  startDate: Date,
  endDate: Date,
  eventTypes?: EventType[]
) {
  return prisma.analyticsEvent.findMany({

```yaml

where: {
  createdAt: {

```yaml
gte: startDate,
lte: endDate,

```

  },
  ...(eventTypes ? { eventType: { in: eventTypes } } : {}),
},
select: {
  eventType: true,
  properties: true,
  createdAt: true,
  userId: true,  // Only ID, no PII
},
orderBy: { createdAt: 'asc' },

```markdown

  })
}

/**

 * Get analytics summary for dashboard/overview.

 *

 * @param days - Number of days to summarize (default 7)

 */
export async function getAnalyticsSummary(days: number = 7) {
  const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)

  const [totalEvents, uniqueUsers, eventsByType] = await Promise.all([

```yaml

// Total events
prisma.analyticsEvent.count({
  where: { createdAt: { gte: cutoffDate } },
}),

// Unique users
prisma.analyticsEvent.findMany({
  where: { createdAt: { gte: cutoffDate } },
  distinct: ['userId'],
  select: { userId: true },
}),

// Events by type
prisma.analyticsEvent.groupBy({
  by: ['eventType'],
  where: { createdAt: { gte: cutoffDate } },
  _count: { id: true },
  orderBy: { _count: { id: 'desc' } },
}),

```
  ])

  return {

```yaml

period: { start: cutoffDate, end: new Date(), days },
totalEvents,
uniqueUsers: uniqueUsers.length,
eventsByType: eventsByType.map((e) => ({
  type: e.eventType,
  count: e._count.id,
})),

```yaml
  }
}

```yaml

AVOID: Selecting user.email or other PII in queries - only use userId.
  </action>
  <verify>

- File compiles without TypeScript errors
- `npm run typecheck` passes
- Query functions can be imported

  </verify>
  <done>Query functions for user timeline, event type filtering, usage stats,
  and brain export</done>
</task>

<task type="auto">
  <name>Task 2: Create data retention utilities</name>
  <files>src/shared/lib/analytics/retention.ts</files>
  <action>
Create `src/shared/lib/analytics/retention.ts` with GDPR-compliant retention
utilities:

```typescript

import 'server-only'
import { prisma } from '@/shared/lib/db'

// Default retention period per research - GDPR safe
const DEFAULT_RETENTION_DAYS = 90

/**

 * Purge analytics events older than the retention period.
 * Should be run as a scheduled job (e.g., daily cron).

 *

 * @param retentionDays - Number of days to retain (default 90)
 * @returns Number of events deleted

 */
export async function purgeExpiredEvents(
  retentionDays: number = DEFAULT_RETENTION_DAYS
): Promise<{ deleted: number; cutoffDate: Date }> {
  const cutoffDate = new Date(

```text

Date.now() - retentionDays * 24 * 60 * 60 * 1000

```
  )

  const result = await prisma.analyticsEvent.deleteMany({

```yaml

where: {
  createdAt: {

```yaml
lt: cutoffDate,

```

  },
},

```javascript
  })

  console.log(

```text

`[Analytics] Purged ${result.count} events older than ${retentionDays} days ` +
`(before ${cutoffDate.toISOString()})`

```
  )

  return {

```yaml

deleted: result.count,
cutoffDate,

```markdown

  }
}

/**

 * Get retention statistics for monitoring.
 * Shows event distribution by age to plan retention policies.

 */
export async function getRetentionStats() {
  const now = new Date()

  // Count events in different age buckets
  const [last7Days, last30Days, last90Days, total] = await Promise.all([

```yaml

prisma.analyticsEvent.count({
  where: {

```
createdAt: { gte: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000) },

```yaml

  },
}),
prisma.analyticsEvent.count({
  where: {

```
createdAt: { gte: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000) },

```yaml

  },
}),
prisma.analyticsEvent.count({
  where: {

```
createdAt: { gte: new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000) },

```text

  },
}),
prisma.analyticsEvent.count(),

```
  ])

  // Get oldest and newest events
  const [oldest, newest] = await Promise.all([

```yaml

prisma.analyticsEvent.findFirst({
  orderBy: { createdAt: 'asc' },
  select: { createdAt: true },
}),
prisma.analyticsEvent.findFirst({
  orderBy: { createdAt: 'desc' },
  select: { createdAt: true },
}),

```yaml
  ])

  return {

```yaml

total,
byAge: {
  last7Days,
  last30Days,
  last90Days,
  older: total - last90Days,
},
dateRange: {
  oldest: oldest?.createdAt || null,
  newest: newest?.createdAt || null,
},
retentionDays: DEFAULT_RETENTION_DAYS,

```
  }
}

/**

 * Purge all analytics data for a specific user.
 * Required for GDPR "right to be forgotten" requests.

 *

 * @param userId - User ID to delete data for
 * @returns Number of events deleted

 */
export async function purgeUserData(
  userId: string
): Promise<{ deleted: number }> {
  const result = await prisma.analyticsEvent.deleteMany({

```yaml

where: { userId },

```javascript
  })

  console.log(`[Analytics] Purged ${result.count} events for user ${userId}`)

  return { deleted: result.count }
}

```yaml

CRITICAL: purgeUserData is required for GDPR "right to be forgotten" compliance.

AVOID: Making retention period too short initially - 90 days allows enough data
for brain pattern analysis while staying GDPR-compliant.
  </action>
  <verify>

- File compiles without TypeScript errors
- `npm run typecheck` passes
- Functions are properly typed

  </verify>
  <done>Retention utilities with purge, stats, and GDPR user data
  deletion</done>
</task>

<task type="auto">
  <name>Task 3: Create export API endpoint</name>
  <files>src/app/api/analytics/export/route.ts</files>
  <action>
Create `src/app/api/analytics/export/route.ts` with authenticated export
endpoint:

```typescript

import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/shared/lib/auth'
import { exportEventsForBrain, getAnalyticsSummary } from '@/shared/lib/analytics/queries'
import { getRetentionStats } from '@/shared/lib/analytics/retention'
import type { EventType } from '@/shared/lib/analytics/types'

/**

 * GET /api/analytics/export

 *

 * Export analytics data for brain analysis.
 * Requires authentication.

 *

 * Query parameters:
 * - startDate: ISO date string (required)
 * - endDate: ISO date string (required)
 * - eventTypes: Comma-separated event types (optional)
 * - format: 'json' (default) or 'summary'

 *

 * Examples:
 * GET /api/analytics/export?startDate=2026-01-01&endDate=2026-01-31
 * GET /api/analytics/export?startDate=2026-01-01&endDate=2026-01-31&eventTypes=task_created,task_updated
 * GET /api/analytics/export?format=summary

 */
export async function GET(request: NextRequest) {
  // Require authentication
  const session = await auth()
  if (!session?.user?.id) {

```

return NextResponse.json(
  { error: 'Unauthorized' },
  { status: 401 }
)

```javascript
  }

  const searchParams = request.nextUrl.searchParams
  const format = searchParams.get('format') || 'json'

  // Handle summary format
  if (format === 'summary') {

```bash

const days = parseInt(searchParams.get('days') || '7', 10)
const [summary, retention] = await Promise.all([
  getAnalyticsSummary(days),
  getRetentionStats(),
])

return NextResponse.json({
  summary,
  retention,
  exportedAt: new Date().toISOString(),
})

```javascript
  }

  // Validate required parameters for full export
  const startDateStr = searchParams.get('startDate')
  const endDateStr = searchParams.get('endDate')

  if (!startDateStr || !endDateStr) {

```

return NextResponse.json(
  { error: 'Missing required parameters: startDate and endDate' },
  { status: 400 }
)

```javascript
  }

  const startDate = new Date(startDateStr)
  const endDate = new Date(endDateStr)

  // Validate dates
  if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {

```json

return NextResponse.json(
  { error: 'Invalid date format. Use ISO 8601 (YYYY-MM-DD)' },
  { status: 400 }
)

```text
  }

  if (startDate > endDate) {

```

return NextResponse.json(
  { error: 'startDate must be before endDate' },
  { status: 400 }
)

```javascript
  }

  // Parse optional event types filter
  const eventTypesStr = searchParams.get('eventTypes')
  const eventTypes = eventTypesStr

```yaml

? (eventTypesStr.split(',') as EventType[])
: undefined

```javascript
  // Export data
  const events = await exportEventsForBrain(startDate, endDate, eventTypes)

  return NextResponse.json({

```

meta: {
  startDate: startDate.toISOString(),
  endDate: endDate.toISOString(),
  eventTypes: eventTypes || 'all',
  count: events.length,
  exportedAt: new Date().toISOString(),
},
events,

```yaml
  })
}

```yaml

CRITICAL: Authentication is required - never expose analytics data publicly.

AVOID: Returning PII in the export - only userId (internal ID), not email or
name.
  </action>
  <verify>

- File compiles without TypeScript errors
- `curl <http://localhost:3000/api/analytics/export`> returns 401

  (unauthenticated)

- Endpoint works when authenticated (test via browser after login)

  </verify>
  <done>Export API endpoint with authentication, date filtering, and summary
  mode</done>
</task>

<task type="auto">
  <name>Task 4: Update barrel exports</name>
  <files>src/shared/lib/analytics/index.ts</files>
  <action>
Update `src/shared/lib/analytics/index.ts` to export all functions:

```typescript

// Event tracking
export { trackEvent, trackEventAsync, trackSessionEvent } from './tracker'
export { AnalyticsEventSchema, type AnalyticsEvent, type EventType } from './types'

// GitHub API integration
export {
  enrichUserWithGitHubData,
  enrichUser,
  checkRateLimitStatus,
  getGitHubAccessToken,
} from './github'

// Query functions
export {
  getUserEventTimeline,
  getEventsByType,
  getFeatureUsageStats,
  exportEventsForBrain,
  getAnalyticsSummary,
} from './queries'

// Data retention
export {
  purgeExpiredEvents,
  getRetentionStats,
  purgeUserData,
} from './retention'

```yaml

This makes all analytics functionality available via single import:

```typescript

import {
  trackEvent,
  enrichUser,
  getAnalyticsSummary,
  purgeExpiredEvents,
} from '@/shared/lib/analytics'

```html

  </action>
  <verify>

- File compiles without TypeScript errors
- All functions can be imported from `@/shared/lib/analytics`

  </verify>
  <done>Complete barrel export with all analytics functions</done>
</task>

</tasks>

<verification>

1. TypeScript compiles: `npm run typecheck` or `npx tsc --noEmit`
2. Development server starts: `npm run dev`
3. Export API works:
   - GET /api/analytics/export without auth → 401
   - GET /api/analytics/export?format=summary (authenticated) → summary JSON
   - GET /api/analytics/export?startDate=2026-01-01&endDate=2026-01-31 → events

```text
 JSON

```

4. All imports work from `@/shared/lib/analytics`
5. Retention stats return valid data structure

</verification>

<success_criteria>

1. Query functions exist for timeline, type filtering, usage stats, and brain

export

2. Retention utilities support purging expired events and user data
3. Export API requires authentication and supports date filtering
4. Summary mode provides quick overview without full data export
5. All functions exported from `@/shared/lib/analytics`
6. GDPR compliance: user data can be deleted, events auto-purge after 90 days
7. No PII in exports - only user IDs

</success_criteria>

<output>
After completion, create
`.planning/phases/06-github-integration-analytics/06-03-SUMMARY.md`
</output>
