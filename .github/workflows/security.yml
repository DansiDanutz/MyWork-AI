name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."

          # Check for common API key patterns
          if grep -rE "(sk-ant-|sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|gsk_[a-zA-Z0-9]+)" \
            --include="*.py" --include="*.js" --include="*.ts" --include="*.md" \
            --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null; then
            echo "WARNING: Potential API keys found in code!"
            exit 1
          fi

          # Check for .env files that shouldn't be committed
          if find . -name ".env" -not -name ".env.example" | grep -q .; then
            echo "WARNING: .env file found in repository!"
            exit 1
          fi

          echo "No secrets detected."

  dependency-scan:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Check for known vulnerabilities
        run: |
          pip install safety

          # Find and check requirements files
          for req in $(find . -name "requirements*.txt" -not -path "./projects/*/node_modules/*"); do
            echo "Checking $req..."
            safety check -r "$req" --full-report || true
          done

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install linters
        run: |
          pip install flake8 bandit

      - name: Run Flake8
        run: |
          flake8 tools/ --max-line-length=120 --ignore=E501,W503 || true

      - name: Run Bandit Security Linter
        run: |
          bandit -r tools/ -ll || true

  gitignore-check:
    name: Gitignore Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify sensitive files not tracked
        run: |
          echo "Checking that sensitive files are not tracked..."

          SENSITIVE_PATTERNS=(
            ".env"
            ".mcp.json"
            "brain_data.json"
            "module_registry.json"
            "*.pem"
            "*.key"
            "credentials.json"
          )

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if git ls-files | grep -q "$pattern"; then
              echo "ERROR: Sensitive file pattern '$pattern' found in git!"
              exit 1
            fi
          done

          echo "All sensitive patterns properly ignored."
